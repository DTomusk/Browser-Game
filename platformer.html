<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
	<canvas id="canvas" width="800" height="600"></canvas>

	<script type="text/javascript">
		var canvas;
		var ctx; 
		var fps = 24;
		// when in the air vy of any object increases by 0.5 every frame
		var g = 1;
		// camera
		var xShift = 0;
		var yShift = 0;

		// load all objects into the scene and stuff
		window.onload = function() {
			canvas = document.getElementById('canvas');
			ctx = canvas.getContext('2d');


			// we want to load levels from somewhere, we want to have the initial states of the levels written 

			// the camera is the canvas, everything should translate when the camera moves 


			// initial objects, should be in its own place
			var tree = new Oak(70, 130);
			var player = new Actor(100, 100, 20, 20, [new Component(0,0,20,20,"grey")]);

			var friend = new Talker(150, 100, 20, 20, [new Component(0,0,20,20,"orange")]);

			var enemy = new Actor(400, 100, 20, 30, [new Component(0,0,20,30,"red")]);

			var level2 = new Level(500, 500, [],[],[],[],[]);

			var level = new Level(1200, 600, [], 
				[new Object(0, 500, 1000, 100, [new Component(0,0,1000,100,"blue")]), new Object(300, 480, 40, 40, [new Component(0,0,40,40,"DarkGoldenRod")])],[tree],[player, enemy, friend],[new Door(200, 400, 100, 100, level2)]);

			var levels = [level];
			
			// the actual game 
			setInterval(function() {
				moveStuff(level, xShift, yShift);
				// ideally the camera logic would be in a different place but I don't want to deal with refactoring it as of yet 
				if ((player.x - xShift > 2*canvas.width/3 && player.vx > 0 && xShift < level.width - canvas.width) || (player.x - xShift < canvas.width/3 && player.vx < 0 && xShift > 0)) {
					xShift += player.vx;
				};
				if ((player.y - yShift > 2*canvas.height/3 && player.vy > 0 && yShift < level.height - canvas.height) || (player.y - yShift < canvas.height/3 && player.vy < 0 && yShift > 0)) {
					yShift += player.yx;
				};
				drawStuff(level, xShift, yShift);
			}, 1000/fps);


			// event listeners, mostly for key presses 
			// these handle the logic of actor states, if the players is in this state do that etc.
			// the player state should inform the possible actions at a given moment 
			window.addEventListener("keydown", function(evt) {
				switch(evt.keyCode) {

					case 37:
						if (player.state == "ground" || player.state == "air") {
							player.vx = -5;
						}
						break;
					case 39:
						if (player.state == "ground" || player.state == "air") {
							player.vx = 5;
						}
						break;
				}
			});

			window.addEventListener("keyup", function(evt) {
				switch(evt.keyCode) {
					case 39:
						if (player.vx > 0) {
							player.vx = 0;
						}
						break;
					case 37:
						if (player.vx < 0) {
							player.vx = 0;
						}
						break;
					case 32: 
						if (player.state == "ground") {
							player.vy -= 10;
							player.state = "air";
						}
						break;
					// e for interaction
					// if character.state == talking then if there's more speech display that, else clear speech bubble and change state to idle 
					case 69:
						if (player.state == "talking") {
							// when they're talking it should be known who they're talking too 
							if (player.partner.speech[player.partner.speech.length-1] == level.speech) {
								level.speech = null;
								player.state = "ground";
							} else {
								player.convIndex += 1;
								level.speech = player.partner.speech[player.convIndex];
							}
						} else if (player.state == "ground") {
							level.interactables.forEach(item => {
								if (playerNear(player, item)) {
									if (item instanceof Door) {
										// loadLevel(item.destination)
										clearScreen();
										level = item.destination;
									}
								}
							})
							level.actors.forEach(person => {
								if (playerNear(player, person)) {
									if (person instanceof Talker) {
										// player.state = talking or something like that
										player.state = "talking";
										player.partner = person;
										player.convIndex = 0;
										level.speech = person.speech[player.convIndex];
									}
								}
							})
						}
						break;
				}
			})		
		}
	</script>
	<script type="text/javascript" src="level.js"></script>
	<script type="text/javascript" src="move.js"></script>
	<script type="text/javascript" src="draw.js"></script>

</body>
</html>